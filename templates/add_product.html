{% extends "index.html" %}

{% block content %}
<div class="bg-white p-6 rounded shadow max-w-xl mx-auto">
  <h2 id="formTitle" class="text-2xl font-bold mb-4">Add New Product</h2>

  <div id="priceError" class="hidden text-red-600 text-lg font-semibold text-center mb-4">
    Invalid input: Price must be a number.
  </div>

  <form onsubmit="event.preventDefault(); saveProduct();">
    <div class="mb-4">
      <label class="block mb-1 font-medium">ID</label>
      <input 
        type="text" 
        id="productId" 
        class="form-input w-full px-4 py-2 border rounded bg-gray-100" 
        readonly
      >
    </div>
    <div class="mb-4">
      <label class="block mb-1 font-medium">Product Name</label>
      <input type="text" id="productName" class="form-input w-full px-4 py-2 border rounded" required>
    </div>
    <div class="mb-4">
      <label class="block mb-1 font-medium">Supplier (FK)</label>
      <input type="text" id="supplier" class="form-input w-full px-4 py-2 border rounded" required>
    </div>
    <div class="mb-4">
      <label class="block mb-1 font-medium">Model</label>
      <input type="text" id="model" class="form-input w-full px-4 py-2 border rounded" required>
    </div>
    <div class="mb-4">
      <label class="block mb-1 font-medium">Price</label>
      <div class="flex items-center border rounded px-3 py-2">
        <span class="text-gray-600 mr-2">Rs.</span>
        <input 
          type="text" 
          id="price" 
          class="flex-1 outline-none" 
          placeholder="Enter amount" 
          required
        >
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <a href="/product" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Back</a>
      <div class="space-x-2">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save</button>
        <button 
          id="deleteBtn" 
          type="button" 
          class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden" 
          onclick="deleteProduct()"
        >
          Delete
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const editId = urlParams.get('id');

  function generateNewProductId(products) {
    let maxNum = 0;
    products.forEach(p => {
      const match = p.id.match(/^P_(\d+)$/);
      if (match) {
        const num = parseInt(match[1], 10);
        if (num > maxNum) maxNum = num;
      }
    });
    const newNum = (maxNum + 1).toString().padStart(2, '0');
    return `P_${newNum}`;
  }

  function loadProductForEdit() {
    const products = JSON.parse(localStorage.getItem("products")) || [];

    if (editId) {
      document.getElementById('formTitle').innerText = 'Edit Product';
      document.getElementById('deleteBtn').classList.remove('hidden');

      const product = products.find(p => p.id === editId);

      if (product) {
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('supplier').value = product.supplier;
        document.getElementById('model').value = product.model;
        document.getElementById('price').value = product.price;
      }
    } else {
      // Auto-generate new ID if adding
      const newId = generateNewProductId(products);
      document.getElementById('productId').value = newId;
    }
  }

  function saveProduct() {
    const id = document.getElementById('productId').value.trim();
    const name = document.getElementById('productName').value.trim();
    const supplier = document.getElementById('supplier').value.trim();
    const model = document.getElementById('model').value.trim();
    const price = document.getElementById('price').value.trim();
    const priceError = document.getElementById('priceError');

    priceError.classList.add('hidden');

    if (!id || !name || !supplier || !model || !price) {
      alert("Please fill all fields.");
      return;
    }

    if (isNaN(price)) {
      priceError.classList.remove('hidden');
      return;
    }

    const products = JSON.parse(localStorage.getItem("products")) || [];
    const newProduct = { id, name, supplier, model, price };
    const existingIndex = products.findIndex(p => p.id === id);

    if (!editId) {
      if (existingIndex !== -1) {
        alert("ID already exists!");
        return;
      }

      if (!confirm("Are you sure you want to save?")) return;

      products.push(newProduct);
      localStorage.setItem("products", JSON.stringify(products));
      alert("Product saved!");
      window.location.href = "/product";
      return;
    }

    const editIndex = products.findIndex(p => p.id === editId);

    if (editId !== id && existingIndex !== -1) {
      alert("ID already exists!");
      return;
    }

    if (editIndex !== -1) {
      if (!confirm("Are you sure you want to save changes?")) return;

      products[editIndex] = newProduct;
      localStorage.setItem("products", JSON.stringify(products));
      alert("Product updated!");
      window.location.href = "/product";
    } else {
      alert("Product not found.");
    }
  }

  function deleteProduct() {
    if (!confirm("Are you sure you want to delete this product?")) return;

    const products = JSON.parse(localStorage.getItem("products")) || [];
    const updated = products.filter(p => p.id !== editId);

    localStorage.setItem("products", JSON.stringify(updated));
    alert("Product deleted.");
    window.location.href = "/product";
  }

  window.onload = function () {
    loadProductForEdit();

    // Enable Up, Down, and Enter key navigation between inputs
    const inputs = Array.from(document.querySelectorAll('input'));

    inputs.forEach((input, index) => {
      input.addEventListener('keydown', function (e) {
        const key = e.key;

        if (key === 'ArrowDown' || key === 'Enter') {
          e.preventDefault();
          if (index < inputs.length - 1) inputs[index + 1].focus();
        }

        if (key === 'ArrowUp') {
          e.preventDefault();
          if (index > 0) inputs[index - 1].focus();
        }
      });
    });
  };
</script>
{% endblock %}
