{% extends "index.html" %}
{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-4">Create Inquiry</h2>
  <div class="grid grid-cols-2 gap-4">
    <select id="customerSelect" class="border p-2 rounded">
      {% for c in customers %}
      <option value="{{ c.id }}">{{ c.customer_id }} - {{ c.name }}</option>
      {% endfor %}
    </select>

    <select id="productSelect" class="border p-2 rounded">
      {% for p in products %}
      <option value="{{ p.id }}">{{ p.product_id }} - {{ p.name }}</option>
      {% endfor %}
    </select>

    <input id="quantity" type="number" placeholder="Quantity" class="border p-2 rounded col-span-1" />
    <input id="terms" type="text" placeholder="Terms" class="border p-2 rounded col-span-1" />
  </div>
  <button onclick="createInquiry()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded">Add Inquiry</button>
</div>

<!-- Inquiry Table -->
<div class="max-w-6xl mx-auto mt-6">
  <table class="w-full border-collapse border">
    <thead class="bg-gray-200">
      <tr>
        <th>Inquiry #</th>
        <th>Customer</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="inquiryTable"></tbody>
  </table>
</div>

<!-- Customer Purchase Modal -->
<div id="customerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
  <div class="bg-white p-6 rounded w-1/2">
    <h2 class="text-lg font-bold mb-4" id="customerModalTitle"></h2>
    <table class="w-full border">
      <thead class="bg-gray-100">
        <tr><th>Inquiry #</th><th>Product</th><th>Qty</th><th>Date</th></tr>
      </thead>
      <tbody id="customerPurchaseTable"></tbody>
    </table>
    <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded">Close</button>
  </div>
</div>

<script>
async function fetchInquiries() {
  const res = await fetch("/api/inquiries");
  const data = await res.json();
  const tbody = document.getElementById("inquiryTable");
  tbody.innerHTML = "";

  function getStatusBadge(status) {
    const statusMap = {
      "Inquiry": { emoji: "🟡", color: "bg-yellow-500" },
      "Quoting": { emoji: "🟠", color: "bg-orange-600" },
      "Quotation Finalized": { emoji: "🟢", color: "bg-green-600" },
      "Payment Received": { emoji: "🔵", color: "bg-blue-600" },
      "In Shipment": { emoji: "🔄", color: "bg-indigo-600" },
      "Arrived KTM": { emoji: "🛬", color: "bg-purple-600" },
      "Delivered": { emoji: "✅", color: "bg-teal-600" },
      "Closed": { emoji: "🌟", color: "bg-pink-600" }
    };
    const s = statusMap[status] || { emoji: "❔", color: "bg-gray-400" };
    return `<span class="px-2 py-1 rounded text-white ${s.color}">${s.emoji} ${status}</span>`;
  }

  data.forEach(inq => {
    tbody.innerHTML += `
      <tr class="border">
        <td>${inq.inquiry_number}</td>
        <td><button onclick="viewCustomer('${inq.customer_id}', '${inq.customer_name}')" class="text-blue-600 underline">${inq.customer_name}</button></td>
        <td>${inq.product_name}</td>
        <td>${inq.quantity}</td>
        <td>${getStatusBadge(inq.status)}</td>
        <td>
          <button onclick="deleteInquiry('${inq.id}')" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button>
        </td>
      </tr>
    `;
  });
}

async function createInquiry() {
  const data = {
    customer_id: document.getElementById("customerSelect").value,
    product_id: document.getElementById("productSelect").value,
    quantity: parseInt(document.getElementById("quantity").value, 10) || 0,
    terms: document.getElementById("terms").value
  };
  const res = await fetch("/api/inquiries", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });
  if (res.ok) {
    // clear input fields after success
    document.getElementById("quantity").value = "";
    document.getElementById("terms").value = "";
    fetchInquiries();
  } else {
    const err = await res.json();
    alert("Failed to add inquiry: " + (err.error || JSON.stringify(err)));
  }
}

async function deleteInquiry(id) {
  if (!confirm("Delete this inquiry?")) return;
  const res = await fetch(`/api/inquiries/${id}`, {method: "DELETE"});
  if (res.ok) {
    fetchInquiries();
  } else {
    const err = await res.json();
    alert("Failed to delete inquiry: " + (err.error || JSON.stringify(err)));
  }
}

async function viewCustomer(customer_id, customer_name) {
  const res = await fetch(`/api/customer/${customer_id}/purchases`);
  const data = await res.json();
  document.getElementById("customerModalTitle").innerText = `${customer_name} - Purchase History`;
  const tbody = document.getElementById("customerPurchaseTable");
  tbody.innerHTML = "";
  data.forEach(inq => {
    tbody.innerHTML += `<tr><td>${inq.inquiry_number}</td><td>${inq.product_name}</td><td>${inq.quantity}</td><td>${new Date(inq.created).toLocaleDateString()}</td></tr>`;
  });
  document.getElementById("customerModal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("customerModal").classList.add("hidden");
}

// Initial load
fetchInquiries();
</script>


{% endblock %}
